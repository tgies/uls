name: Integration Tests

on:
  schedule:
    # Run weekly on Sundays at 14:00 UTC (after FCC updates)
    - cron: '0 14 * * 0'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of integration test'
        type: choice
        options:
          - full
          - quick
          - consistency
        default: quick

env:
  FCC_DATA_BASE_URL: "https://data.fcc.gov/download/pub/uls"
  CARGO_TERM_COLOR: always

jobs:
  quick-integration:
    name: Quick Integration Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type != 'consistency'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
      
      - name: Build all crates
        run: cargo build --release --all
      
      - name: Download amateur license data
        run: |
          mkdir -p test-data
          curl -sS -o test-data/l_amat.zip \
            -H "User-Agent: ULS-CLI-Integration/1.0" \
            "${FCC_DATA_BASE_URL}/complete/l_amat.zip"
          
          unzip -q test-data/l_amat.zip -d test-data/l_amat
      
      - name: Run parser on real data
        run: |
          # Count records per file type
          for dat in test-data/l_amat/*.dat; do
            echo "$(basename $dat): $(wc -l < "$dat") records"
          done
      
      - name: Validate parsing
        run: cargo test --release -p uls-parser -- --ignored 2>/dev/null || echo "No integration tests yet"

  database-build:
    name: Full Database Build Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'full' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Build CLI
        run: cargo build --release -p uls-cli
      
      - name: Download all amateur data
        run: |
          mkdir -p test-data/{complete,daily}
          
          # Weekly database
          curl -sS -o test-data/complete/l_amat.zip \
            "${FCC_DATA_BASE_URL}/complete/l_amat.zip"
          
          # Daily updates (may not all exist)
          for day in mon tue wed thu fri sat; do
            curl -sS -o "test-data/daily/l_am_${day}.zip" \
              "${FCC_DATA_BASE_URL}/daily/l_am_${day}.zip" 2>/dev/null || true
          done
          
          ls -la test-data/complete/
          ls -la test-data/daily/
      
      - name: Build database from weekly
        run: |
          # Future: Run actual CLI command
          # ./target/release/uls update --source test-data/complete/l_amat.zip --db test-data/uls.db
          echo "Database build test placeholder"
      
      - name: Run lookup tests
        run: |
          # Future: Test lookups
          # ./target/release/uls lookup W1AW --db test-data/uls.db
          echo "Lookup test placeholder"

  consistency-check:
    name: Database Consistency Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'consistency'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Build CLI
        run: cargo build --release -p uls-cli
      
      - name: Download this week's and last week's data
        run: |
          mkdir -p test-data/{current,previous}
          
          # Current weekly
          curl -sS -o test-data/current/l_amat.zip \
            "${FCC_DATA_BASE_URL}/complete/l_amat.zip"
          
          # Note: FCC doesn't keep historical weeklies, so this test
          # would need to use cached data from a previous run
          echo "Consistency check requires cached previous week data"
      
      - name: Compare databases
        run: |
          # Future: Build two databases and compare key metrics
          # - Total license count
          # - License status distribution
          # - New licenses this week
          # - Expired licenses
          echo "Consistency check placeholder"

  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [quick-integration]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.quick-integration.result }}" >> $GITHUB_STEP_SUMMARY
