name: Integration Tests

on:
  schedule:
    # Run weekly on Sundays at 14:00 UTC (after FCC updates)
    - cron: '0 14 * * 0'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of integration test'
        type: choice
        options:
          - full
          - quick
        default: quick
      force_download:
        description: 'Force fresh download (ignore cache)'
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  FCC_DATA_BASE_URL: "https://data.fcc.gov/download/pub/uls"

jobs:
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-integration-
      
      - name: Build CLI
        run: cargo build --release -p uls-cli
      
      - name: Run unit tests
        run: cargo test --all --verbose

  full-database-build:
    name: Full Database Build Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'full' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-integration-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache FCC amateur data
        id: cache-fcc-data
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uls
          key: fcc-amateur-data-${{ github.run_id }}
          restore-keys: |
            fcc-amateur-data-
      
      - name: Build CLI
        run: cargo build --release -p uls-cli
      
      - name: Download and import amateur data
        run: |
          if [[ "${{ github.event.inputs.force_download }}" == "true" ]]; then
            echo "Force download requested, clearing cache..."
            rm -rf ~/.cache/uls
          fi
          
          ./target/release/uls update --service amateur
      
      - name: Verify database stats
        run: |
          ./target/release/uls stats
      
      - name: Test callsign lookup
        run: |
          ./target/release/uls lookup W1AW --format json
      
      - name: Test FRN lookup
        run: |
          # Look up ARRL's FRN
          ./target/release/uls frn 0001387578 --format json

  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: [integration-test]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date -u +%Y-%m-%d)" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.integration-test.result }}" >> $GITHUB_STEP_SUMMARY
